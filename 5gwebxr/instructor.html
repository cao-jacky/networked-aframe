<html>

<head>
    <meta charset="utf-8">
    <title>5GWebXR: Instructor</title>
    <meta name="description" content="HoloLens Experience">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/networked-aframe@^0.9.0/dist/networked-aframe.min.js"
        crossorigin="anonymous"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js" crossorigin="anonymous"></script>
    <script src="/dist/naf-janus-adapter.js"></script>

    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"
        crossorigin="anonymous"></script>

    <script src="https://kit.fontawesome.com/83f0ae3239.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/assets/css/instructor.css" type="text/css" media="all" crossorigin="anonymous">
    

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bree+Serif&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/main.css" />
    <script>
        NAF.connection.subscribeToDataChannel('reliableBroadcast', function() {
          var label = document.getElementById('reliable-broadcast');
          label.innerHTML = 'success';
          label.className = 'success';
        });
  
        NAF.connection.subscribeToDataChannel('augmentationStatus', function(senderId, dataType, data, targetObj) {
          var label = document.getElementById('unreliable-broadcast');
          label.innerHTML = 'success';
          label.className = 'success';
          console.log(data);
        });
  
        NAF.connection.subscribeToDataChannel('reliableSend', function() {
          var label = document.getElementById('reliable-send');
          label.innerHTML = 'success';
          label.className = 'success';
        });
  
        NAF.connection.subscribeToDataChannel('unreliableSend', function() {
          var label = document.getElementById('unreliable-send');
          label.innerHTML = 'success';
          label.className = 'success';
        });
      </script>
</head>

<body class="is-preload homepage">
    <div id="page-wrapper">
        <div id="header-wrapper">
            <header id="header" class="container">

                <!-- Logo -->
                    <div id="logo">
                        <h1>CoWebXR</h1>
                    </div>

                <!-- Nav -->
                    <nav id="nav">
                        <ul>
                            <li class="current"><a href="index.html">Welcome</a></li>
                            <li>
                                <a href="#">Dropdown</a>
                                <ul>
                                    <li><a href="#">Lorem ipsum dolor</a></li>
                                    <li><a href="#">Magna phasellus</a></li>
                                    <li>
                                        <a href="#">Phasellus consequat</a>
                                        <ul>
                                            <li><a href="#">Lorem ipsum dolor</a></li>
                                            <li><a href="#">Phasellus consequat</a></li>
                                            <li><a href="#">Magna phasellus</a></li>
                                            <li><a href="#">Etiam dolore nisl</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="#">Veroeros feugiat</a></li>
                                </ul>
                            </li>
                            <li><a href="left-sidebar.html">Left Sidebar</a></li>
                            <li><a href="right-sidebar.html">Right Sidebar</a></li>
                            <li><a href="no-sidebar.html">No Sidebar</a></li>
                        </ul>
                    </nav>

            </header>
        </div>

        <div id="main-wrapper">
            <div class="container">
                <h2>Instructor</h2>
                <div class="row gtr-200">
                    <div class="col-4 col-12-medium">
                        <!-- Sidebar -->
                            <div id="sidebar">
                                <section class="widget thumbnails">
                                    <div><p>As the instructor, you have access to tools to control and edit the content that is available for the user to view.</p></div>
                                    <h3>Controls</h3>
                                    <div class="grid">
                                        <div class="row gtr-50">
                                            <div class="col-6">
                                                <div class="actions">
                                                    <button id="camera-btn" type="button" class="button">Show Camera to User</button>
                                                    <!-- <button id="scene-btn" type="button" class="button">Start streaming scene</button> -->
                                                </div>
                                            </div>
                                            <div>
                                                <p>Broadcast reliable test result: <span id="reliable-broadcast" class="fail">waiting</span></p>
                                                <p>Broadcast unreliable  test result: <span id="unreliable-broadcast" class="fail">waiting</span></p>
                                                <p>Send reliable test result: <span id="reliable-send" class="fail">waiting</span></p>
                                                <p>Send unreliable test result: <span id="unreliable-send" class="fail">waiting</span></p>
                                              </div>
                                            <!-- <div class="col-6"><a href="#" class="image fit"><img src="images/pic04.jpg" alt="" /></a></div>
                                            <div class="col-6"><a href="#" class="image fit"><img src="images/pic05.jpg" alt="" /></a></div>
                                            <div class="col-6"><a href="#" class="image fit"><img src="images/pic06.jpg" alt="" /></a></div>
                                            <div class="col-6"><a href="#" class="image fit"><img src="images/pic07.jpg" alt="" /></a></div> -->
                                        </div>
                                    </div>
                                    <!-- <a href="#" class="button icon fa-file-alt">More</a> -->
                                </section>
                            </div>

                    </div>

                    <div class="col-8 col-12-medium imp-medium">
                        <div id="aframe_scene">
                            <a-scene
                            embedded
                            mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/examples/image-tracking/assets/card-example/card.mind; uiScanning: no"
                            color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
                            device-orientation-permission-ui="enabled: false" networked-scene="
                            room: 1;
                            debug: false;
                            adapter: janus;
                            connectOnLoad: true;
                            serverURL: wss://192.168.1.101:8989/janus; ">
                            <a-assets>
                                <img id="card"
                                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/examples/image-tracking/assets/card-example/card.png" />
                                <a-asset-item id="avatarModel"
                                    src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/examples/image-tracking/assets/card-example/softmind/scene.gltf">
                                </a-asset-item>

                                <img id="chevron" src="/assets/arrow_white.png" />

                                <template id="avatar-template" type="text/html">
                                    <a-entity class="avatar" networked-audio-source>
                                    <a-plane id="avatarPlane" width="10" height="20" position="0 5 0" 
                                    rotation="0 0 0" material="side: front; transparent: true" networked-video-source></a-plane>                  
                                    </a-entity>
                                </template>

                                <template id="content_template" type="text/html">
                                    <a-entity position="0 0.3 0">
                                        <a-plane id="data_item" material="side: double; color: #303971; transparent: true; opacity: 0.5" height="0.7" width="1" depth="0.01">
                                            <a-text position="-0.47 0.25 0" scale="0.5 0.5 0.5" value="Computer"></a-text>
                                            <a-text position="-0.46 0.13 0" wrap-count="26" scale="0.15 0.15 0.15" value="Use this computer to set the settings of the laser cutter."></a-text>
                                        </a-plane>
                            
                                        <a-circle material="side: double; color: #303971; transparent: true; opacity: 0.5" position="-0.7 0 0" radius="0.1">
                                            <a-image src="#chevron" material="alphaTest: 0.5" position="0 0 0.01" width="1" scale="0.1 0.1 0.1" rotation="0 180 0"></a-image>
                                        </a-circle>
                    
                                        <a-circle material="side: double; color: #303971; transparent: true; opacity: 0.5" position="0.7 0 0" radius="0.1">
                                            <a-image src="#chevron" material="alphaTest: 0.5" position="0 0 0.01" width="1" scale="0.1 0.1 0.1" rotation="0 0 0"></a-image>
                                        </a-circle>
                            
                                        <a-plane material="side: double; color: #303971; transparent: true; opacity: 0" position="0 -0.5 0" height="0.2" width="1" depth="0.01">
                                            <a-plane material="side: double; color: #303971; transparent: true; opacity: 0.5;" position="-0.39 0 0" height="0.2" width="0.2" depth="0.02"></a-plane>
                                            <a-plane material="side: double; color: #303971; transparent: true; opacity: 0.5;" position="-0.13 0 0" height="0.2" width="0.2" depth="0.02"></a-plane>
                                            <a-plane material="side: double; color: #303971; transparent: true; opacity: 0.5;" position="0.13 0 0" height="0.2" width="0.2" depth="0.02"></a-plane>
                                            <a-plane material="side: double; color: #303971; transparent: true; opacity: 0.5;" position="0.39 0 0" height="0.2" width="0.2" depth="0.02"></a-plane>
                                        </a-plane>
                    
                                    </a-entity>
                                </template>
                            </a-assets>

                            <a-camera look-controls="enabled: true" wasd-controls="enabled: true" position="0 0 0" fit>
                                <a-entity 
                                    id="player" 
                                    networked="template:#avatar-template;attachTemplateToLocal:false" 
                                    position="0 -5 -15" rotation="0 0 0">
                                </a-entity>
                            </a-camera>

                            </a-scene>
                        </div>
                    </div>


    
                </div>

            </div>
        </div>

    <style>
        .actions {
            position: absolute;
            display: flex;

        }

        .button {
            cursor: pointer;
            background: #fff;
            height: 40px;
            width: 130px;
            border-radius: 30px;
        }

        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out
        }

        #config_menu {
            display: none;
        }

        @keyframes octocat-wave {

            0%,
            100% {
                transform: rotate(0)
            }

            20%,
            60% {
                transform: rotate(-25deg)
            }

            40%,
            80% {
                transform: rotate(10deg)
            }
        }

        @media (max-width:500px) {
            .github-corner:hover .octo-arm {
                animation: none
            }

            .github-corner .octo-arm {
                animation: octocat-wave 560ms ease-in-out
            }
        }
    </style>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.dropotron.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
        function genClientId() {
            let num = '';
            for (let i = 0; i < 16; i++) {
                num += Math.floor(Math.random() * 10).toString();
            }
            return num;
        }

        const state = {};
        state.currentStream = null;
        state.cameraEnabled = false;
        state.sceneStreamingEnabled = false;

        // Prompt for audio.
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            const cameraBtnEl = document.getElementById('camera-btn');
            // const sceneBtnEl = document.getElementById('scene-btn');

            const stopAndRemoveVideoTrack = async () => {
                const videoTracks = state.currentStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    videoTracks[0].stop();
                    state.currentStream.removeTrack(videoTracks[0]);
                    await NAF.connection.adapter.setLocalMediaStream(state.currentStream);
                }
            };

            // Handle camera button click (Show and Hide)
            cameraBtnEl.addEventListener('click', async () => {
                if (state.sceneStreamingEnabled) {
                    await stopAndRemoveVideoTrack();
                    state.sceneStreamingEnabled = false;
                    // sceneBtnEl.textContent = 'Start streaming scene';
                }

                if (state.cameraEnabled) {
                    await stopAndRemoveVideoTrack();
                } else {
                    const stream = await navigator.mediaDevices.getUserMedia(
                        {
                            video: {
                                mediaSource: "camera",
                                // height: { max: 1280 },
                                // width: { max: 720 },
                                frameRate: { max: 60, ideal: 30},
                                facingMode: { ideal: "environment" }
                            }
                        });
                    state.currentStream.addTrack(stream.getVideoTracks()[0]);
                    await NAF.connection.adapter.setLocalMediaStream(state.currentStream);
                }

                state.cameraEnabled = !state.cameraEnabled;
                cameraBtnEl.textContent = state.cameraEnabled ? 'Hide Camera to User' : 'Show Camera to User';
            });

            scene.addEventListener('adapter-ready', ({ detail: adapter }) => {
                // We don't use the syncOccupants API, set requestedOccupants to be the same array instance as availableOccupants
                adapter.requestedOccupants = adapter.availableOccupants;
                const clientId = genClientId(); // generate a random 16 characters string, but you can use a uuid4 for example
                adapter.setClientId(clientId);
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    adapter.setLocalMediaStream(stream).then(() => {
                        // Note that networked-scene audio:true option has no effect with the janus adapter
                        adapter.enableMicrophone(false); // set it to false if you want to be muted initially.
                        state.currentStream = stream;
                        adapter.setLocalMediaStream(stream);
                    });
                }).catch(err => {
                    console.warn("Microphone access not allowed. This client will not broadcast audio.");
                });
            });
        });

    </script>

    <script>
        // Define custom schema for syncing avatar color, set by random-color
        NAF.schemas.add({
            template: '#avatar-template',
            components: [
                'position',
                'rotation',
                {
                    selector: '.head',
                    component: 'material',
                    property: 'color'
                }
            ]
        });
        // Called by Networked-Aframe when connected to server
        function onConnect() {
            console.log("onConnect", new Date());
        }
    </script>
    
    <script>
        AFRAME.registerComponent("fit", {
            init: function() {
                const plane = document.querySelector("#avatarPlane");
                const distance = this.el.object3D.position.distanceTo(plane.object3D.position);
                const height = plane.getAttribute("geometry").height;
                const fov = this.el.sceneEl.camera.fov * (Math.PI / 180);
                const newDistance = Math.abs((height / 2) / Math.tan(fov / 2));
                this.el.sceneEl.camera.zoom = distance / newDistance;
            }
        })
    </script>
</body>

