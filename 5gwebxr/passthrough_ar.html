<html>

<head>
    <meta charset="utf-8">
    <title>5GWebXR: Passthrough AR Experience</title>
    <meta name="description" content="HoloLens Experience">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image.prod.js"></script> -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

    <script src='/aframe/aframe-ar-nft.js'></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>


    <!-- <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js"></script> -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/networked-aframe@^0.9.0/dist/networked-aframe.min.js"
        crossorigin="anonymous"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js" crossorigin="anonymous"></script>
    <script src="/dist/naf-janus-adapter.js"></script>

    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"
        crossorigin="anonymous"></script>

    <script src="https://kit.fontawesome.com/83f0ae3239.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/assets/css/passthrough_ar.css" type="text/css" media="all" crossorigin="anonymous">

    <script>
        function sendEvents() {
            NAF.connection.broadcastDataGuaranteed('reliableBroadcast', '');
            NAF.connection.broadcastData('unreliableBroadcast', '');

            var clients = NAF.connection.getConnectedClients();

            var firstClient;
            for (firstClient in clients) break;

            console.error(clients);
            console.error(firstClient);

            NAF.connection.sendDataGuaranteed(firstClient, 'reliableSend', '');
            NAF.connection.sendData(firstClient, 'unreliableSend', '');
        }
    </script>

</head>

<body>
    <a-scene
        arjs="trackingMethod: best; sourceType: webcam;debugUIEnabled: false; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false" gesture-detector networked-scene="
        room: 1;
        debug: false;
        adapter: janus;
        connectOnLoad: true;
        serverURL: wss://5gwebxr.com:8989/janus;">
        <a-assets>
            <img id="card"
                src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/examples/image-tracking/assets/card-example/card.png" />
            <a-asset-item id="avatarModel"
                src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/examples/image-tracking/assets/card-example/softmind/scene.gltf">
            </a-asset-item>

            <img id="chevron" src="assets/icons/arrow_white.png" />

            <template id="avatar-template" type="text/html">
                <a-entity class="avatar" networked-audio-source>
                    <a-plane id="avatarPlane" width="1.5" height="1.5" position="0 1 0" rotation="0 0 0"
                        material="side: front" networked-video-source></a-plane>
                </a-entity>
            </template>

            <template id="test" type="text/html">
                <a-plane position="0 0.3 0" id="data_item"
                    material="side: double; color: #303971; transparent: true; opacity: 0.5" height="0.7" width="1"
                    depth="0.01">
                </a-plane>
            </template>

            <a-asset-item id="bowser" src="https://cdn.glitch.com/06bd98b4-97ee-4c07-a546-fe39ca205034%2Fbowser.glb">
            </a-asset-item>

        </a-assets>

        <a-camera look-controls="enabled: false" wasd-controls="enabled: false" position="0 0 0" fit>
            <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:false;" position="0 -6 -1"
                rotation="0 0 0" onhover>
            </a-entity>

        </a-camera>
    </a-scene>

    <style>
        .actions {
            position: absolute;
            display: flex;
            bottom: 0.5%;
            left: 3%;
        }

        .button {
            cursor: pointer;
            background: #fff;
            height: 40px;
            width: 130px;
            border-radius: 30px;
        }

        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out
        }

        #config_menu {
            display: none;
        }

        @keyframes octocat-wave {

            0%,
            100% {
                transform: rotate(0)
            }

            20%,
            60% {
                transform: rotate(-25deg)
            }

            40%,
            80% {
                transform: rotate(10deg)
            }
        }

        @media (max-width:500px) {
            .github-corner:hover .octo-arm {
                animation: none
            }

            .github-corner .octo-arm {
                animation: octocat-wave 560ms ease-in-out
            }
        }
    </style>


    <div class="actions">
        <button id="camera-btn" type="button" class="button">Show Camera</button>
        <!-- <button id="scene-btn" type="button" class="button">Start streaming scene</button> -->
    </div>

    <!-- Button to spawn the interaction menu -->
    <div class="overlay_menu">
        <button id="menu_btn" type="button" hidden>Menu</button>
    </div>

    <div class="card_selector" id="card_selector">
        <button class="menu_items" type="button" id="card_left_select" hidden>
            < </button>
                <button class="menu_items" type="button" id="card_right_select" hidden> > </button>
    </div>

    <div class="overlay_box" id="config_menu" style="display: none;">
        <div>hello</div>
        <button class="menu_items" type="button" id="menu_usr_btn">User</button>
    </div>

    <div class="overlay_box" id="user_menu" style="display: none;">
        <div class="menu_title">User</div>
        <button class="menu_items" type="button" id="usr_slc_btn">Select user</button><br>
        <button class="menu_items" type="button" id="usr_crt_btn">Create user</button>
    </div>

    <div class="overlay_box" id="user_create" style="display: none;">
        <div class="menu_title">User details</div>
        <form id="user_create_form">
            <label for="fname">First name:</label><br>
            <input type="text" id="fname" name="fname"><br>
            <label for="lname">Last name:</label><br>
            <input type="text" id="lname" name="lname"><br>
            <input class="submit_btn" id="user_create_submit_btn" type="submit" value="Submit">
        </form>
    </div>

    <div class="overlay_box" id="user_list" style="display: none;">
        <div class="menu_title">Select user</div>
        <table class="custom_lists" id="table_user_list">
            <!-- <tr>
                <th>test1</th>
                <th>test2</th>
                <th>test3</th>
            </tr> -->
        </table>
    </div>

    <div class="overlay_box" id="status_box" style="display: none;">
        <div>User was created</div>
    </div>

    <script>
        function change_user(user) {
            console.log(user);
        }
    </script>

    <script>
        function genClientId() {
            let num = '';
            for (let i = 0; i < 16; i++) {
                num += Math.floor(Math.random() * 10).toString();
            }
            return num;
        }

        const state = {};
        state.currentStream = null;
        state.cameraEnabled = false;
        state.sceneStreamingEnabled = false;

        // Prompt for audio.
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            const cameraBtnEl = document.getElementById('camera-btn');
            // const sceneBtnEl = document.getElementById('scene-btn');

            const menu_btn_el = document.getElementById('menu_btn');
            const menu_el = document.getElementById('config_menu');

            const user_btn_el = document.getElementById('menu_usr_btn');
            const user_menu_el = document.getElementById('user_menu');

            const user_cr_btn_el = document.getElementById('usr_crt_btn');
            const user_cr_el = document.getElementById('user_create');
            const user_cr_sb_btn_el = document.getElementById('user_create_submit_btn');

            const user_sl_btn_el = document.getElementById('usr_slc_btn');
            const user_sl_el = document.getElementById('user_list');

            const table_usrs_el = document.getElementById('table_user_list');

            const status_box_el = document.getElementById('status_box');

            const card_left_el = document.getElementById('card_left_select');
            const card_right_el = document.getElementById('card_right_select');

            const stopAndRemoveVideoTrack = async () => {
                const videoTracks = state.currentStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    videoTracks[0].stop();
                    state.currentStream.removeTrack(videoTracks[0]);
                    await NAF.connection.adapter.setLocalMediaStream(state.currentStream);
                }
            };

            // Handle camera button click (Show and Hide)
            cameraBtnEl.addEventListener('click', async () => {
                if (state.sceneStreamingEnabled) {
                    await stopAndRemoveVideoTrack();
                    state.sceneStreamingEnabled = false;
                    // sceneBtnEl.textContent = 'Start streaming scene';
                }

                if (state.cameraEnabled) {
                    await stopAndRemoveVideoTrack();
                } else {
                    const stream = await navigator.mediaDevices.getUserMedia(
                        {
                            video: {
                                mediaSource: "camera",
                                // height: { max: 1280 },
                                // width: { max: 720 },
                                frameRate: { max: 60, ideal: 30 },
                                facingMode: { ideal: "environment" }
                            }
                        });
                    state.currentStream.addTrack(stream.getVideoTracks()[0]);
                    await NAF.connection.adapter.setLocalMediaStream(state.currentStream);
                }

                state.cameraEnabled = !state.cameraEnabled;
                cameraBtnEl.textContent = state.cameraEnabled ? 'Hide Camera' : 'Show Camera';
            });

            // Handle scene streaming button click (Start and Stop)
            // sceneBtnEl.addEventListener('click', async () => {
            //     if (state.cameraEnabled) {
            //         await stopAndRemoveVideoTrack();
            //         state.cameraEnabled = false;
            //         cameraBtnEl.textContent = 'Show Camera';
            //     }

            //     if (state.sceneStreamingEnabled) {
            //         await stopAndRemoveVideoTrack();
            //     } else {
            //         const stream = scene.canvas.captureStream(30);
            //         state.currentStream.addTrack(stream.getVideoTracks()[0]);
            //         await NAF.connection.adapter.setLocalMediaStream(state.currentStream);
            //     }

            //     state.sceneStreamingEnabled = !state.sceneStreamingEnabled;
            //     sceneBtnEl.textContent = state.sceneStreamingEnabled ? 'Stop streaming scene' : 'Start streaming scene';
            // });

            menu_btn_el.addEventListener('click', async () => {
                if (menu_el.style.display === "none") {
                    menu_el.style.display = "block";
                } else {
                    menu_el.style.display = "none";
                }
            });

            user_btn_el.addEventListener('click', async () => {
                if (user_menu_el.style.display === "none") {
                    user_menu_el.style.display = "block";
                } else {
                    user_menu_el.style.display = "none";
                }

                if (user_sl_el.style.display === "block") {
                    user_sl_el.style.display = "none";
                }

                if (user_cr_el.style.display === "block") {
                    user_cr_el.style.display = "none";
                }

            });

            user_cr_btn_el.addEventListener('click', async () => {
                if (user_menu_el.style.display === "block") {
                    user_menu_el.style.display = "none";
                } else {
                    user_menu_el.style.display = "block";
                }
                user_cr_el.style.display = "block";

            });

            function retrieve_data(route) {
                const XHR = new XMLHttpRequest();

                XHR.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        const user_list = JSON.parse(this.responseText);
                        const total_users = user_list.length;

                        for (var i = 0; i < total_users; i++) {
                            let curr_user = user_list[i];
                            var new_row = table_usrs_el.insertRow(-1);

                            var cell_fname = new_row.insertCell(0);
                            var cell_surname = new_row.insertCell(1);
                            var cell_button_select = new_row.insertCell(2);

                            cell_fname.innerHTML = curr_user["first_name"];
                            cell_surname.innerHTML = curr_user["surname"];

                            cell_button_select.innerHTML = `<button class="user_select_button" onclick="change_user('${curr_user["id"]}')">Select</button>`;

                            cell_button_select.style = "text-align: right";
                        }

                        // const table_sl_user = document.getElementById('user_selected');
                        // table_sl_user.addEventListener('click', async () => {
                        //     const selected_user = table_sl_user.dataset.user_id;
                        //     console.log(selected_user);
                        // });
                    }
                };
                // Set up our request
                XHR.open("GET", `https://5gwebxr.com:8444/${route}/`);

                // The data sent is what the user provided in the form
                // XHR.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                XHR.send();
            }

            user_sl_btn_el.addEventListener('click', async () => {
                retrieve_data("user_list")
                if (user_menu_el.style.display === "block") {
                    user_menu_el.style.display = "none";
                } else {
                    user_menu_el.style.display = "block";
                }
                user_sl_el.style.display = "block";
            });

            // card selector behaviour
            card_left_el.addEventListener('click', async () => {
                // read card string, convert to JSON
                var card_data = $("#card_selector").attr("cards");
                var cd_decoded = JSON.parse(decodeURIComponent(card_data));

                var card_status = $("#card_selector").attr("status");

                // read current card ID
                var curr_card_status = card_status.split("/");
                var curr_card = parseInt(curr_card_status[0]) - 1;

                console.log("curr card " + curr_card);

                var total_cards = curr_card_status[1];

                // set new card status
                var new_card = curr_card - 1;

                console.log("new card " + new_card);

                if (new_card < total_cards || new_card > 0) {
                    // change card content
                    $("#marker_content").attr("value", cd_decoded[`${new_card}`].card_content);

                    $("#card_selector").attr("status", `${new_card + 1}/${total_cards}`);
                    $("#card_tracker").attr("value", `${new_card + 1}/${total_cards}`);
                }
            });

            card_right_el.addEventListener('click', async () => {
                // read card string, convert to JSON
                var card_data = $("#card_selector").attr("cards");
                var cd_decoded = JSON.parse(decodeURIComponent(card_data));

                var card_status = $("#card_selector").attr("status");

                // read current card ID
                var curr_card_status = card_status.split("/");
                var curr_card = parseInt(curr_card_status[0]) - 1;
                var total_cards = curr_card_status[1];

                // set new card status
                var new_card = curr_card + 1;

                if (new_card < total_cards) {
                    // change card content
                    $("#marker_content").attr("value", cd_decoded[`${new_card}`].card_content);

                    $("#card_selector").attr("status", `${new_card + 1}/${total_cards}`);
                    $("#card_tracker").attr("value", `${new_card + 1}/${total_cards}`);
                }
            });



            // });

            // user_cr_sb_btn_el.addEventListener('click', async () => {
            //     $('#user_create_submit_btn').click(function () { 
            //         var data = {
            //             first_name:$('#fname').val(),
            //             last_name:$('#lname').val()
            //         }
            //     $.ajax({
            //         type: "POST",
            //         url: "https://5gwebxr.com:8444/user_data/",
            //         contentType:'application/json',
            //         dataType: "json",
            //         data:JSON.stringify(data),
            //         success: function (result) {
            //                 console.log(result);
            //         }
            //     }); });
            // });

            function send_data(form_data, route) {
                const XHR = new XMLHttpRequest();

                XHR.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // Behaviour if server was able to receive and insert user
                        // console.log(this.responseText);
                        if (user_cr_el.style.display === "block") {
                            user_cr_el.style.display = "none";
                        }

                        if (status_box_el.style.display === "none") {
                            status_box_el.style.display = "block";
                        }

                        setTimeout(function () {
                            $('#status_box').fadeOut('fast');
                        }, 5000); // <-- time in milliseconds


                    }
                };

                // Set up our request
                XHR.open("POST", `https://5gwebxr.com:8444/${route}/`);

                // The data sent is what the user provided in the form
                XHR.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                XHR.send(form_data);
                // console.log(form_data);
            }

            const form = document.getElementById("user_create_form");
            form.addEventListener("submit", async () => {
                event.preventDefault();
                var form_data = $("form").serializeArray();
                var json_form_data = JSON.stringify(form_data);
                send_data(json_form_data, "user_create");
            });

            scene.addEventListener('adapter-ready', ({ detail: adapter }) => {
                // We don't use the syncOccupants API, set requestedOccupants to be the same array instance as availableOccupants
                adapter.requestedOccupants = adapter.availableOccupants;
                const clientId = genClientId(); // generate a random 16 characters string, but you can use a uuid4 for example
                adapter.setClientId(clientId);
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    adapter.setLocalMediaStream(stream).then(() => {
                        // Note that networked-scene audio:true option has no effect with the janus adapter
                        adapter.enableMicrophone(false); // set it to false if you want to be muted initially.
                        state.currentStream = stream;
                        adapter.setLocalMediaStream(stream);
                    });
                }).catch(err => {
                    console.warn("Microphone access not allowed. This client will not broadcast audio.");
                });
            });


        });

    </script>

    <script>
        function retrieve_data(route) {
            const XHR = new XMLHttpRequest();

            XHR.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    const returned_data = JSON.parse(this.responseText);
                    const num_items = returned_data.length;

                    if (route == "markers") {
                        // create markers programatically from data returned from server
                        const camera = document.querySelector('a-camera');
                        const sceneEl = document.querySelector('a-scene');

                        for (var i = 0; i < num_items; i++) {
                            let curr_marker = returned_data[i];
                            let cm_value = curr_marker.marker_value;
                            let cm_id = curr_marker.marker_id;
                            let cm_title = curr_marker.marker_title;

                            let cm_cards = curr_marker.cards;
                            var card_data_str = encodeURIComponent(JSON.stringify(cm_cards));

                            // console.log(cm_value, cm_id);

                            // create marker to be recognised and store all details there
                            const newMarker = document.createElement("a-marker");
                            newMarker.setAttribute("type", "barcode");
                            newMarker.setAttribute("value", cm_value);
                            newMarker.setAttribute("id", cm_id);
                            newMarker.setAttribute("title", cm_title);
                            newMarker.setAttribute("cards", card_data_str);

                            newMarker.setAttribute("registerevents", "");

                            sceneEl.appendChild(newMarker);
                        }


                    }
                }
            };
            // Set up our request
            XHR.open("GET", `https://5gwebxr.com:8444/${route}/`);

            // The data sent is what the user provided in the form
            // XHR.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            XHR.send();
            // console.log(form_data);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // request from the database, the shortlist of IDs
            retrieve_data("markers");

        });
    </script>

    <script>
        AFRAME.registerComponent('registerevents', {
            init: function () {
                var marker = this.el;
                marker.setAttribute('emitevents', 'true');
                marker.addEventListener('markerFound', function () {
                    var markerId = marker.id;
                    console.log('markerFound', markerId);

                    // if marker found, create marker content and append to this element

                    // create the marker content
                    const marker_content = document.createElement("a-entity");
                    marker_content.setAttribute("id", "markerContent");
                    marker_content.setAttribute("scale", "4 2 4");
                    marker_content.setAttribute("rotation", "-45 0 0");

                    // set marker plane
                    const marker_plane = document.createElement("a-plane");
                    marker_plane.setAttribute("id", "markerPlane");
                    marker_plane.setAttribute("material", "side: double; color: #303971; transparent: true; opacity: 0.75");
                    marker_plane.setAttribute("height", "0.7");
                    marker_plane.setAttribute("width", "1");
                    marker_plane.setAttribute("depth", "0.01");

                    // set title 
                    const marker_title = document.createElement("a-text");
                    marker_title.setAttribute("id", "markerTitle");
                    marker_title.setAttribute("position", "-0.47 0.25 0.02");
                    marker_title.setAttribute("scale", "0.5 0.5 0.5");
                    marker_title.setAttribute("value", marker.title);

                    // set content
                    const marker_cards = document.createElement("a-text");
                    marker_cards.setAttribute("id", "marker_content");
                    marker_cards.setAttribute("position", "-0.46 0.13 0.02");
                    marker_cards.setAttribute("scale", "0.15 0.15 0.15");
                    marker_cards.setAttribute("wrap-count", "26");

                    var cards_data = $(`#${markerId}`).attr("cards");
                    var cd_decoded = JSON.parse(decodeURIComponent(cards_data));
                    marker_cards.setAttribute("value", cd_decoded[0].card_content);

                    // set the card tracker
                    const card_tracker = document.createElement("a-text");
                    card_tracker.setAttribute("id", "card_tracker");
                    card_tracker.setAttribute("position", "0.4 -0.3 0.02");
                    card_tracker.setAttribute("scale", "0.15 0.15 0.15");
                    card_tracker.setAttribute("value", `1/${cd_decoded.length}`);

                    // unhiding the card selector buttons
                    $("#card_left_select").removeAttr("hidden");
                    $("#card_right_select").removeAttr("hidden");

                    // selecting the card data to a specific element
                    $("#card_selector").attr("cards", cards_data);
                    $("#card_selector").attr("status", `1/${cd_decoded.length}`);

                    // // set left select arrow
                    // const left_arrow_selector = document.createElement("a-circle");
                    // left_arrow_selector.setAttribute("material", "side: double; color: #303971; transparent: true; opacity: 0.5");
                    // left_arrow_selector.setAttribute("radius", "0.1");

                    // const left_arrow_icon = document.createElement("a-image");
                    // left_arrow_icon.setAttribute("src", "#chevron");
                    // left_arrow_icon.setAttribute("material", "alphaTest: 0.5");
                    // left_arrow_icon.setAttribute("width", "1");
                    // left_arrow_icon.setAttribute("scale", "0.1 0.1 0.1");
                    // left_arrow_icon.setAttribute("position", "0 0 0.02");
                    // left_arrow_icon.setAttribute("rotation", "0 180 0");

                    // left_arrow_selector.appendChild(left_arrow_icon);
                    // left_arrow_selector.setAttribute("position", "-0.65 0 0");
                    // left_arrow_selector.setAttribute("id", "view_marker_left_select");
                    // // left_arrow_selector.setAttribute("gesture-handler", "");

                    // // set left select arrow
                    // const right_arrow_selector = document.createElement("a-circle");
                    // right_arrow_selector.setAttribute("material", "side: double; color: #303971; transparent: true; opacity: 0.5");
                    // right_arrow_selector.setAttribute("radius", "0.1");

                    // const right_arrow_icon = document.createElement("a-image");
                    // right_arrow_icon.setAttribute("src", "#chevron");
                    // right_arrow_icon.setAttribute("material", "alphaTest: 0.5");
                    // right_arrow_icon.setAttribute("width", "1");
                    // right_arrow_icon.setAttribute("scale", "0.1 0.1 0.1");
                    // right_arrow_icon.setAttribute("position", "0 0 0.02");
                    // right_arrow_icon.setAttribute("rotation", "0 0 0");

                    // right_arrow_selector.appendChild(right_arrow_icon);
                    // right_arrow_selector.setAttribute("position", "0.65 0 0");
                    // right_arrow_selector.setAttribute("id", "view_marker_right_select");

                    // marker_content.appendChild(right_arrow_selector);
                    // marker_content.appendChild(left_arrow_selector);
                    marker_plane.appendChild(card_tracker);
                    marker_plane.appendChild(marker_cards);
                    marker_plane.appendChild(marker_title);
                    marker_content.appendChild(marker_plane);
                    marker.appendChild(marker_content);

                    // $(`#${markerId}`).attr("raycaster", "objects: .clickable");
                    // $(`#${markerId}`).attr("emitevents", "true");
                    // $(`#${markerId}`).attr("cursor", "fuse: false; rayOrigin: mouse;");

                    // $("#markerContent").attr("class", "clickable");
                    $("#markerContent").attr("clickhandler", "");

                    console.log(marker);

                    // $.ajax({
                    //     type: "POST",
                    //     url: "https://5gwebar.5gear.net:8080/",
                    //     contentType: "application/json",
                    //     data: JSON.stringify({
                    //         markerId: markerId
                    //     }),
                    //     success: function (data) {
                    //         var t = JSON.parse(data);
                    //         console.log(data);
                    //         var htmlstr = JSON.parse(t['payload']);
                    //         document.getElementById(markerId).innerHTML = htmlstr['response'];
                    //         // document.querySelector("#" + markerId + ' a-entity').setAttribute('rotation', "270 0 0");
                    //         //document.querySelector("#" + markerId + ' a-video').play();
                    //     },
                    //     dataType: "text"
                    // }).done(function (data) {
                    // });
                    const camera = document.querySelector('a-camera');
                    let cameraPosition = camera.object3D.position;
                    let markerPosition = marker.object3D.position;
                    let distance = cameraPosition.distanceTo(markerPosition)

                    // check = setInterval(() => {
                    //     cameraPosition = camera.object3D.position;
                    //     markerPosition = marker.object3D.position;
                    //     distance = cameraPosition.distanceTo(markerPosition)

                    //     // do what you want with the distance:
                    //     console.log(distance);
                    // }, 100);
                });

                marker.addEventListener('markerLost', function () {
                    var markerId = marker.id;
                    console.log('markerLost', markerId);
                    // document.querySelector("#" + markerId + ' a-entity a-video').getAttribute('src')="";
                    document.getElementById(markerId).innerHTML = '';

                    $("#card_left_select").attr("hidden", "");
                    $("#card_right_select").attr("hidden", "");
                    // clearInterval(check);

                });
            }
        });


    </script>

    <script>
        var sceneEl = document.querySelector('a-scene');
        var entityEl = document.createElement('a-entity');
        entityEl.setAttribute('geometry', {
            primitive: 'plane',
            height: 0.5,
            width: 0.25,
        });
        // entityEl.object3D.position.set(0, 0, -1);
        // entityEl.setAttribute('position', { x: 2, y: 2, z: -5 });
        sceneEl.appendChild(entityEl);

        var textEl = document.createElement('a-entity');
        textEl.setAttribute('text', {
            value: '',
            height: 1,
            width: 1
        });
        textEl.setAttribute('id', "recognition");
        textEl.setAttribute('position', { x: 1, y: 0, z: -3 });
        sceneEl.appendChild(textEl);


        function retrieve_recognition(client_id) {
            const XHR = new XMLHttpRequest();

            XHR.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    const returned_data = JSON.parse(this.responseText);
                    const recognition_results = JSON.parse(returned_data[0].results);

                    const num_rr = recognition_results.length;
                    // console.log("window size " + window.innerWidth + "x" + window.innerHeight);

                    if (num_rr > 0) {
                        var textElement = document.getElementById("recognition");
                        textElement.innerHTML = '';
                        for (var i = 0; i < num_rr; i++) {
                            const curr_res = recognition_results[i];

                            const x_min = curr_res.xmin;
                            const x_max = curr_res.xmax;

                            const y_min = curr_res.ymin;
                            const y_max = curr_res.ymax;

                            const x_min_norm = x_min / 640;
                            const y_min_norm = y_min / 480;

                            const x_rat = window.innerWidth / 640;
                            const y_rat = window.innerHeight / 480;

                            const box_width = (x_max-x_min) / 640;
                            const box_height = (y_max-y_min) / 480;

                            var res_box = document.createElement('a-entity');
                            res_box.setAttribute('geometry', {
                                primitive: 'plane',
                                height: box_height*y_rat,
                                width: box_width*x_rat
                            });
                            res_box.setAttribute('material', {
                                opacity: 0.5,
                                transparent: true
                            });
                            res_box.object3D.position.set((x_min_norm*x_rat)-1, (y_min_norm*y_rat)-1.5, -3);


                            // console.log(x_min_norm*x_rat + " " + x_max_norm*x_rat);

                            var new_el = document.createElement('a-entity');
                            new_el.setAttribute('text', {
                                value: curr_res.name,
                                height: 2,
                                width: 2
                            });
                            new_el.setAttribute('id', "recognition");
                            new_el.setAttribute('position', { x: 1, y: 0, z: 0 });
                            res_box.appendChild(new_el);
                            textElement.appendChild(res_box);

                        }
                    }

                }
            };
            XHR.open("GET", `https://5gwebxr.com:8444/recognition/${client_id}/`);
            XHR.send();
        }

        const interval = window.setInterval(function () {
            console.log("Requesting latest recognition results for self client " + NAF.connection.adapter.clientId);
            retrieve_recognition(NAF.connection.adapter.clientId)
        }, 100);

    // clearInterval(interval);

    </script>


    <script>
        // Define custom schema for syncing avatar color, set by random-color
        NAF.schemas.add({
            template: '#avatar-template',
            components: [
                'position',
                'rotation',
                {
                    selector: '.head',
                    component: 'material',
                    property: 'color'
                }
            ]
        });
        // Called by Networked-Aframe when connected to server
        function onConnect() {
            console.log("onConnect", new Date());
            // setTimeout(sendEvents, 3000);
        }

    </script>
</body>

</html>