<html>
<head>
    <meta charset="utf-8">
    <title>Basic AR Example — Networked-Aframe</title>
    <meta name="description" content="Basic AR Example — Networked-Aframe">

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="/dist/networked-aframe.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>
    <!-- AR -->
    <script src="https://rawgit.com/jeromeetienne/ar.js/master/aframe/build/aframe-ar.js"></script>
    <script>THREEx.ArToolkitContext.baseURL = 'https://rawgit.com/jeromeetienne/ar.js/master/three.js/'</script>

    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.5/dist/aframe-particle-system-component.min.js"></script>
    <script src="js/spawn-in-circle.component.js"></script>
   
    <script>
        function onARConnect() {
            console.log('AR Client Connected');
        }
    </script>
</head>
  <body>

      <a-scene arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
                networked-scene="room: basic-video; debug: true; adapter: easyrtc; audio: true; video: true; onConnect: onARConnect;"
               >
          <a-assets>
              <!-- Templates -->
              <!-- Avatar -->
              <img id="arrowImg" src="arrow.png" />
              <template id="avatar-template">
                  <a-entity class="avatar">
                  </a-entity>
              </template>
              <template id="marker-template">
                  <a-entity material="color: red"
                            rotation="270 0 0"
                            text="xOffset:7; width:13;" position="0 0 -1">
                      <a-text align="left" class="aentitiyblock" width="7" value="" color="green"></a-text>

                  </a-entity>
                  <!-- static camera that moves according to the device movemenents -->
              </template>
              <template id="pointer-template">
                  <a-entity gltf-model="#arrow3d" material="metalness: 0.8; color:green;" scale="0.15 0.15 0.15">
                      <a-torus position="0 0 0" scale="0.01 0.01 0.01" id="pointergeo" color="#43A367" radius="0.1" radius-tubular="0.1" clickpointd></a-torus>
                  </a-entity>
              </template>
              <!-- /Templates -->
          </a-assets>

          <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
          <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>
          <a-marker type="barcode" size="0.06" value="0" id="ftextA" registerevents>
              <a-entity>
                  <a-text align="left" class="aentitiyblock" width="7" value="Marker 1" color="green"></a-text>
                  <a-image src="#arrowImg" position="-0.5 0 0" width="1" height="1"></a-image>
              </a-entity>
          </a-marker>
          <a-marker type="barcode" size="0.06" value="1" id="stextA" registerevents>
              <a-entity>
                  <a-text align="left" class="aentitiyblock" width="7" value="Marker 1" color="green"></a-text>
                  <a-image src="#arrowImg" position="-0.5 0 0" width="1" height="1"></a-image>
              </a-entity>
          </a-marker>
          <a-marker type="barcode" size="0.06" value="10" id="ttextA" registerevents>
              <a-entity>
                  <a-text align="left" class="aentitiyblock" width="7" value="Marker 1" color="green"></a-text>
                  <a-image src="#arrowImg" position="-0.5 0 0" width="1" height="1"></a-image>
              </a-entity>
          </a-marker>
          <a-marker-camera preset='hiro'></a-marker-camera>
      </a-scene>
        
    <script>
      // Define custom schema for syncing avatar color, set by random-color
      NAF.schemas.add({
        template: '#avatar-template',
        components: [
          'position',
          'rotation',
          {
            selector: '.head',
            component: 'material'
          }
        ]
      });
        NAF.schemas.add({
            template: '#pointer-template',
            components: [
                'position',
                'rotation',
                'scale'
            ]
        });
        NAF.schemas.add({
            template: '#marker-template',
            components: [
                'position',
                'rotation',
                'scale'
            ]
        });
        AFRAME.registerComponent('registerevents', {
            init: function () {
                var marker = this.el;
                marker.setAttribute('emitevents', 'true');
                marker.addEventListener('markerFound', function () {
                    var markerId = marker.id;
                    console.log('markerFound', markerId);
                    $.ajax({
                        type: "POST",
                        url: "https://5gwebar.5gear.net:8080/",
                        contentType: "application/json",
                        data: JSON.stringify({
                            markerId: markerId
                        }),
                        success: function (data) {
                            var t = JSON.parse(data);
                            console.log(data);
                            var htmlstr = JSON.parse(t['payload']);
                            document.getElementById(markerId).innerHTML = '';
                            document.getElementById(markerId).innerHTML = htmlstr['response'];
                        },
                        dataType: "text"
                    }).done(function (data) {
                    });
                });

                marker.addEventListener('markerLost', function () {
                    var markerId = marker.id;
                    console.log('markerLost', markerId);
                //    document.getElementById(markerId).innerHTML = '';
                });
            }
        });
    </script>
  </body>
</html>