<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Image based tracking AR.js demo</title>
    <!-- import aframe and then ar.js with image tracking / location based features -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="/dist/networked-aframe.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-button-controls@^1.1.0/aframe-button-controls.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>
    <script src="https://rawgit.com/jeromeetienne/ar.js/master/aframe/build/aframe-ar.js"></script>
    <script>THREEx.ArToolkitContext.baseURL = 'https://5gwebar.5gear.net:8443/three.js/'</script>

    <!-- style for the loader -->
    <link rel="stylesheet" href="fabstyle.css" type="text/css" media="all">

    <script>

    </script>
    <style>
    </style>
</head>

<body>
    <a-scene networked-scene="room: basic-video; debug: true; adapter: easyrtc; audio: true; video: true;"
              arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
             >
        <a-assets>
            <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">

            <img id="arrowImg"
                 src="arrow.png" />
            <template id="avatar-template">
                <a-entity class="avatar">
                    <a-plane color="#FFF" width="0.45" height="0.8" position="0 0 -1" rotation="0 0 0" material="side: front;opacity: 0.5; transparent: true" networked-video-source></a-plane>
                    <a-plane color="#FFF" width="0.45" height="0.8" position="0 0 -1" rotation="0 0 0" material="side: front;opacity: 0.5; transparent: true" networked-video-source></a-plane>
                </a-entity>
            </template>
            <template id="marker-template">
                <a-entity material="color: red"
                          rotation="270 0 0"
                          text="xOffset:7; width:13;">
                    <a-text align="left" class="aentitiyblock" width="7" value="Wait for support" color="green"></a-text>
                    <a-image src="#arrowImg" position="-0.5 0 0" width="1" height="1"></a-image>
                </a-entity>

                <!-- static camera that moves according to the device movemenents -->
            </template>
            <template id="pointer-template">
                <a-entity id="pointerCtrl" position="0 1.25 -2" scale="0.2 0.2 0.2" drag-rotate-component
                          geometry="primitive: torus; radius:0.5; radiusTubular: 0.1; arc: 180; color: red">
                </a-entity> 
            </template>
        </a-assets>
        <a-entity button-controls></a-entity>

        <a-entity id="pointer" networked="template:#pointer-template;attachTemplateToLocal:false;" position="0 0 0"> </a-entity>
        <a-entity id="player" camera wasd-controls
                  networked="template:#avatar-template;attachTemplateToLocal:false;"
                  position="0 0 0">
            <a-entity id="markerPlacer">
                <a-marker type="barcode" size="0.06" value="0" id="ftextA" registerevents>
                    <a-entity networked="template:#marker-template">
                    </a-entity> 
                </a-marker>
                <a-marker type="barcode" size="0.06" value="1" id="stextA" registerevents>
                    <a-entity networked="template:#marker-template">
                    </a-entity>
                </a-marker>
                <a-marker type="barcode" size="0.06" value="10" id="ttextA" registerevents>
                    <a-entity networked="template:#marker-template">
                    </a-entity>
                </a-marker>
            </a-entity>
            <a-sphere class="head"
                      visible="false"
                      random-color></a-sphere>
        </a-entity>

        <a-entity position="0 -1.6 -100"
                  geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
                  material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

    </a-scene>

    <button id="mic-btn" type="button" class="camera-btn">Mute Mic</button>
    <button id="camera-btn" type="button" class="camera-btn">Hide Cam</button>
    <canvas id="webcam2d" width="1920" height="1080"></canvas>
    <div class="photoview vr-overlay-content">
        <form id="editTextForm">

            <input type="button" value="Stop Image From Client" id="myStopInterval" class="btn btn-danger" onclick="myStopInterval();">
            <input type="button" value="Start Image From Client" class="btn btn-success" id="startInterval" onclick="startInterval();">
            <h5>Configuration in Current Location:</h5>
            <label for="ftext">Tag 1:</label>
            <input type="text" onchange="UpdateText(this.id)" id="ftext" name="ftext" class="updatetextfield" value="Open the cover to start"><br><br>
            <label for="stext">Tag 2:</label>
            <input type="text" onchange="UpdateText(this.id)" id="stext" name="stext" class="updatetextfield" value="Put below this position"><br><br>
            <label for="ttext">Tag 3:</label>
            <input type="text" onchange="UpdateText(this.id)" id="ttext" name="ttext" class="updatetextfield" value="Close the cover"><br><br>

            <input type="button" value="New Tag" id="newTagBtn" class="btn btn-info" onclick="CreateNewTag();">
            <input type="submit" value="Submit">
        </form>
    </div>
    <script>
        // Camera status
        let cameraEnabled = true;

        var markerScale = 0.2;
        // Camera button ele
        const micBtnEle = document.getElementById('mic-btn');
        const cameraBtnEle = document.getElementById('camera-btn');
        NAF.schemas.add({
            template: '#avatar-template',
            components: [
                'position',
                'rotation'
            ]
        }); 
        NAF.schemas.add({
            template: '#pointer-template',
            components: [
                'position',
                'rotation',
                'scale'
            ]
        });
        function onConnect() {
            console.log("onConnect", new Date());

            // Handle camera button click (Off and On)
            cameraBtnEle.addEventListener('click', function () {
                NAF.connection.adapter.enableCamera(!cameraEnabled);
                cameraEnabled = !cameraEnabled;
                cameraBtnEle.textContent = cameraEnabled ? 'Hide Camera' : 'Show Camera';
            });

            document.body.addEventListener('clientConnected', function (evt) {
                var numPlayer = Object.keys(NAF.connection.getConnectedClients()).length;
                console.error('clientConnected event. ' + numPlayer + '  clientId =', evt.detail.clientId);
                if (numPlayer > 2 && evt.detail.clientId > 1) {
                   // document.querySelector("#player").setAttribute('position', { x: numPlayer * 0.5, y: 0, z: 0 });
                }
            }); 
        }
        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect(), // abs. size of element
                scaleX = canvas.width / rect.width,    // relationship bitmap vs. element for X
                scaleY = canvas.height / rect.height;  // relationship bitmap vs. element for Y

            return {
                x: (evt.clientX - rect.left) * scaleX,   // scale mouse coordinates after they have
                y: (evt.clientY - rect.top) * scaleY     // been adjusted to be relative to element
            }
        }

        function UpdateText(targetID) {
            var strupdate = document.getElementById(targetID).value;
            console.log(strupdate);
            var fbtn = "#" + targetID + "A .aentitiyblock";
            document.querySelector(fbtn).setAttribute('value', strupdate);
            var markerId = targetID + "A";
            var element = document.getElementById(markerId);
            var elementHtml = element.innerHTML;
            console.log(elementHtml);
            $.ajax({
                type: "POST",
                url: "https://5gwebar.5gear.net:8080/support",
                contentType: "application/json",
                data: JSON.stringify({
                    markerId: markerId,
                    elementml: elementHtml
                }),
                success: function (data) {
                },
                dataType: "text"
            }).done(function (data) {
                console.log("data" + data);
            });
        }
        AFRAME.registerComponent('drag-rotate-component', {
            schema: { speed: { default: 1 } },

            init: function () {
                this.ifMouseDown = false;
                this.x_cord = 0;
                this.y_cord = 0;
                document.addEventListener('mousedown', this.OnDocumentMouseDown.bind(this));
                document.addEventListener('mouseup', this.OnDocumentMouseUp.bind(this));
                document.addEventListener('mousemove', this.OnDocumentMouseMove.bind(this));
            },
            OnDocumentMouseDown: function (event) {
                var scanvas = document.querySelector('a-scene').components.screenshot.getCanvas('equirectangular');

                this.ifMouseDown = true;
                var widthHalf = scanvas.width / 2, heightHalf = scanvas.height / 2;
                // var vector= getMousePos(scanvas, event);
                //  vector.x = ((event.clientX - widthHalf)) / widthHalf;
                // vector.y = - ((event.clientY - heightHalf) / heightHalf);

                var mouse = { x: 0, y: 0 };
                var camera = document.querySelector('#player');
                var worldPos = new THREE.Vector3();
                worldPos.setFromMatrixPosition(camera.object3D.matrixWorld);

                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                var vector = new THREE.Vector3(mouse.x, mouse.y, -1);
                //  vector.unproject(camera);
                var dir = vector.sub(worldPos).normalize();
                var distance = - worldPos.z / dir.z;
                var pos = worldPos.add(dir.multiplyScalar(distance));

                positionStr = String(pos.x) + " " + String(pos.y) + " " + String(pos.z);
                //document.querySelector('#cursor').setAttribute('position', positionStr);
                this.el.setAttribute('position', positionStr);
                console.log("OnDocumentMouseDown " + worldPos + ", " + positionStr);
                markerScale = 0.3;
                this.el.setAttribute('scale', { x: markerScale, y: markerScale, z: markerScale });
            },
            OnDocumentMouseUp: function () {
                this.ifMouseDown = false;
                console.log("MouseUp " + this.x_cord + ", " + this.y_cord);
            },
            OnDocumentMouseMove: function (event) {
                if (this.ifMouseDown) {
                    //  var scanvas = document.querySelector('a-scene').components.screenshot.getCanvas('equirectangular');

                    //this.x_cord = event.clientX;
                    //this.y_cord = event.clientY;
                    //var widthHalf = scanvas.width / 2, heightHalf = scanvas.height / 2;
                    //var vector = new THREE.Vector3();
                    //vector.x = ((event.clientX - widthHalf)) / widthHalf;
                    //vector.y = - ((event.clientY - heightHalf) / heightHalf);
                    //this.el.setAttribute('position', { x: vector.x, y: vector.y, z: -2 });
                    //console.log("OnDocumentMouseMove " + vector.x + ", " + vector.y);
                    //markerScale = 1;
                    //this.el.setAttribute('scale', { x: markerScale, y: markerScale, z: markerScale });
                }
            }, tick: function () {
                // only move it when certain state is meet
                if (!this.ifMouseDown) {
                    if (markerScale > 0.01) {
                        markerScale = markerScale - 0.01;
                        this.el.setAttribute('scale', { x: markerScale, y: markerScale, z: markerScale });
                    }
                }
            }

        });

        AFRAME.registerComponent('registerevents', {
            init: function () {
                var marker = this.el;

                // Make the element emit events when found and when lost.
                marker.setAttribute('emitevents', 'true');

                marker.addEventListener('markerFound', function () {
                    var markerId = marker.id;
                    console.log('markerFound', markerId);
                    var fbtn = "#" + markerId + " .aentitiyblock";
                    var targetID = markerId.substring(0, markerId.length - 1);
                    var strupdate = document.getElementById(targetID).value;
                    document.querySelector(fbtn).setAttribute('value', strupdate);
                    var element = document.getElementById(markerId);
                    var elementHtml = element.innerHTML;
                    $.ajax({
                        type: "POST",
                        url: "https://5gwebar.5gear.net:8080/support",
                        contentType: "application/json",
                        data: JSON.stringify({
                            markerId: markerId,
                            elementml: elementHtml
                        }),
                        success: function (data) {

                        },
                        dataType: "text"
                    }).done(function (data) {
                        console.log("data" + data);
                    });
                });

                marker.addEventListener('markerLost', function () {
                    var markerId = marker.id;
                    console.log('markerLost', markerId);
                    console.log("Marker Gone!");
                    // TODO: Add your own code here to react to the marker being lost.
                });
            }
        });
        //var photo = document.getElementById("photo");
        var mixedCanvas = document.getElementById("webcam2d");
        var context = mixedCanvas.getContext("2d");
        var markerPlacer = document.querySelector("#markerPlacer")
        var img = new Image;
        img.onload = function () {
            screenwidth = img.width;
            screenheight = img.height;
            context.drawImage(img, 0, 0); // Or at whatever offset you like
        };

        function sendScreen() {

            $.ajax({
                type: "POST",
                url: "https://5gwebar.5gear.net:8080/",
                contentType: "application/json",
                data: JSON.stringify({
                    markerId: "sc",
                }),
                success: function (data) {
                    var t = JSON.parse(data);
                    var htmlstr = JSON.parse(t['payload']);
                    document.getElementById("markerPlacer").innerHTML = htmlstr['response'];
                    //img.src = htmlstr['response'];
                },
                dataType: "text"
            }).done(function (data) {
            });
        }
        //  var receiveCmd = setInterval(sendScreen, 200);
        var btnStop = document.getElementById("myStopInterval");
        var btnStart = document.getElementById("startInterval");
        btnStop.onclick = function () {
            clearInterval(receiveCmd);
            btnStop.style.display = "none";
            btnStart.style.display = "block";
        }
        btnStart.onclick = function () {
            receiveCmd = setInterval(sendScreen, 2000);
            btnStart.style.display = "none";
            btnStop.style.display = "block";
        }
        var btnStart = document.getElementById("newTagBtn");
        function CreateNewTag() {

        }
    </script>
</body>
</html>

